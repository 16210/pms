\chapter{系统轮廓}
\label{ch:profiles}

\section{一般原则}
一般来讲，系统轮廓用于定义针对某一类系统的信息，比如软件包分组，构建配置等。
系统轮廓在仓库中的目录结构相对比较简单，每个系统轮廓都是一个以它名称命名的目录，目录包含
\ref{sec:profile-files} 节所述的文件或目录，同时也可以包含任意数量个储存其他系统轮廓的子目录。
系统轮廓可以继承，各个文件遵循的继承规则不尽相同，具体细节会在下文详述。

系统轮廓的名称应符合 \ref{sec:profile-names} 节的系统轮廓名称规范。为了避免文件名冲突，
系统轮廓不能使用本章以及 \ref{sec:profiles-dir} 节描述的文件和目录的名称。

\section{构成系统轮廓的文件}
\label{sec:profile-files}
如果没有特别说明，本节描述的文件中从 \texttt{\#} 字符到行尾的内容是注释，空白行忽略。

某些文件可以用一个同名目录替代。替代目录下的文件，只要名称不是以点开头，都会按照 POSIX
语言环境下文件名的顺序进行拼接，得到的结果将视为被替代文件的内容，而子目录则会忽略。
这种拼接操作会在继承规则应用之前执行。

本节描述的所有文件都是可选的。

\subsection{继承文件}
一个系统轮廓可以包含一个 \texttt{继承}\ 文件，其中的每一行是到另一个系统轮廓的相对路径，
该系统轮廓将被视为当前系统轮廓的其中一个父系统轮廓。当前系统轮廓的各项设置按照各自的规则
和父系统轮廓的结合，或覆盖父系统轮廓的。这种继承操作以深度优先，
文件中从上到下的顺序进行，每次遇到重复的父系统轮廓都会引入。

系统轮廓的继承树中包含循环是不合法的。软件包管理器遇到循环时的行为不做定义。

此文件中不能有注释、空白行和续行。

\subsection{eapi 文件}
系统轮廓目录可以包含一个 \texttt{eapi} 文件，如果存在的话，该文件中必须只有一行 EAPI 值，
它明确了在处理当前目录时使用的 EAPI；软件包管理器不得尝试使用那些目录需要一个不支持的
EAPI 来处理的系统轮廓。如果 \texttt{eapi} 文件不存在，则应使用仓库 \texttt{eapi} 文件
中的值。EAPI 既不从父系统轮廓继承也不会传给子目录。

\subsection{构建配置文件}
\texttt{构建配置}\ 用来定义各种环境与配置变量的默认值。这个文件不会在
文件层面上与父系统轮廓结合，而是每个变量独立地处理：如果父系统轮廓中的某个
变量在子系统轮廓中没有定义，则子系统轮廓会原样继承此变量，否则变量会如
\ref{sec:profile-variables} 节所述的那样叠加或覆盖。

文件内容是一行一行的变量与值的格式，每一行都是单个的 \verb|变量="值"| 条目，
其中的值必须用双引号引起来。变量的名称必须以 \texttt{a-zA-Z} 开头并且只包含
\texttt{a-zA-Z0-9_}。bash 语法的一小部分，作为额外语法，也允许使用，具体如下：

\begin{compactitem}
\item 等号右边 \texttt{\$\{foo\}} 或 \texttt{\$foo} 这种形式的变量经过识别会根据变量
    在当前位置已赋的值展开。
\item 通过用反斜杠转义换行，一个逻辑行可以跨越多个物理行。双引号引起来的字符串
    跨越多个物理行既可以通过简单换行也可以通过反斜杠转义换行。
\item 除了续行之外，反斜杠不允许使用。
\end{compactitem}

\subsection{软件包分组}
\texttt{软件包分组}\ 文件用于定义系统轮廓提供的软件包分组，每一行的格式为：

\begin{verbatim}
<分组> <成员>
\end{verbatim}

其中：
\begin{compactitem}
\item \texttt{<\hspace{0em}分组\hspace{0em}>} 是一个软件包分组的名称，必须符合
    \ref{sec:group-names} 节的软件包分组名称规范。
\item \texttt{<\hspace{0em}成员\hspace{0em}>} 是一个限定的软件包名称，或者一个 \texttt{@}
    符加一个已定义的分组名称，表示向正在被定义的分组中添加一个软件包或一个分组。这两者的前边
    都可以加一个连字符前缀，表示从正在被定义的分组中移除一个软件包或一个分组。除此之外，
    该字段还可以是字符串 \texttt{-*}，表示移除分组中的所有成员。
\end{compactitem}

字段之间以空格或水平制表符分隔。\texttt{<\hspace{0em}分组\hspace{0em}>}
相同的行之间不能出现定义其他分组的行。

当文件处理完成时，没有一个成员的分组会被取消定义。此文件的继承与结合方式为：
首先分别处理每个父系统轮廓的分组，接着将它们之间名称相同的分组合并，
最后在此基础上处理当前系统轮廓的分组。

如果系统轮廓已在 \texttt{系统轮廓/摘要}\ 中列出，则必须确保至少定义了以下分组：
\begin{description}
\item[最小安装] 系统可以使用的最小软件包集合。
\item[构建工具] 软件包构建的最小工具集合。
\end{description}

\subsection{软件包屏蔽}
\texttt{软件包屏蔽}\ 用于在给定的系统轮廓中阻止某些软件包的安装。文件中的每一行是一个
不带阻塞符、插槽依赖和应用标志依赖的软件包依赖说明符（详见 \ref{sec:package-dependency-spec}
节），说明符的前边可以加一个连字符前缀。不带连字符前缀的说明符表示屏蔽相匹配的软件包，
而带连字符前缀的则表示解除屏蔽相匹配的软件包。

此文件的继承与结合方式为：先照抄 \texttt{系统轮廓/软件包屏蔽}\ 中的内容，随后将每个
父系统轮廓的此文件依次追加到末尾，最后把当前系统轮廓的文件追加到末尾。
对于一个给定的软件包版本，如果有不止一行中的说明符可以匹配，则靠后的行优先级更高。

此文件可以用同名目录替代，详见 \ref{sec:profile-files} 节。

软件包管理器应提供适当的机制允许用户解除某个软件包的屏蔽。

\subsection{应用标志的屏蔽与启用}
\label{sec:use-masking}
系统轮廓可以控制软件包安装时一些应用标志的屏蔽与启用。这种控制通过 8 个文件实现，
这些文件的名称格式一致，从左到右分别是：
\begin{compactitem}
\item “\texttt{稳定版}”或空字符串。
\item “\texttt{全局}”或“\texttt{局部}”。
\item “\texttt{启用}”或“\texttt{屏蔽}”。
\end{compactitem}

这 3 个组成部分分别称为约束，范围和策略。

所有全局范围的文件每一行是一个应用标志，应用标志的前边可以加一个连字符前缀。
这些文件的继承与结合方式为：将每个父系统轮廓中对应的文件按顺序拼接，随后将当前系统
轮廓的文件追加到末尾，如果某个应用标志带有连字符前缀则会将这一行移除，同时把在它之前
应用标志和该应用标志相同的行一起移除。在安装软件包时，软件包管理器会根据文件名中的
策略部分决定为软件包启用还是屏蔽文件列举的应用标志。

所有局部范围的文件针对不同的软件包选定不同的应用标志，每一行的格式为：

\begin{verbatim}
<目标> <应用标志列表>
\end{verbatim}

其中：
\begin{compactitem}
\item \texttt{<\hspace{0em}目标\hspace{0em}>} 是一个不带阻塞符、插槽依赖和应用标志依赖的
    软件包依赖说明符，或者 \texttt{@} 符加一个软件包分组。
\item \texttt{<\hspace{0em}应用标志列表\hspace{0em}>} 是一个或多个以空格分隔的应用标志，
    应用标志的前边可以加一个连字符前缀。不带连字符前缀的应用标志表示针对
    \texttt{<\hspace{0em}目标\hspace{0em}>} 选定一个应用标志，
    而带连字符前缀的则表示取消选定一个应用标志。
\end{compactitem}

\texttt{<\hspace{0em}目标\hspace{0em}>} 和 \texttt{<\hspace{0em}应用标志列表\hspace{0em}>}
之间以空格或水平制表符分隔。针对软件包分组选定应用标志会展开为针对分组中的每一个软件包选定应用标志。

所有局部范围文件的继承与结合方式为：将每个父系统轮廓中对应的文件展开分组后按顺序拼接，随后将
当前系统轮廓的文件展开分组并追加到末尾。需要注意的是，每个父系统轮廓的文件展开分组时是按照
各自的分组定义展开，而不是按照当前系统轮廓的分组定义展开。

在安装软件包时，软件包管理器会从上到下逐行遍历局部范围的文件，如果软件包和
\texttt{<\hspace{0em}目标\hspace{0em}>} 相匹配，就根据
\texttt{<\hspace{0em}应用标志列表\hspace{0em}>} 选定或取消选定应用标志，
遍历完成时根据文件名中的策略部分决定为软件包启用还是屏蔽选定的应用标志。

如果正在安装的软件包是稳定版（见 \ref{sec:keywords} 节），那么文件的生效顺序为：
\texttt{全局启用}，\texttt{全局屏蔽}，\texttt{稳定版全局启用}，\texttt{稳定版全局屏蔽}，
\texttt{局部启用}，\texttt{局部屏蔽}，\texttt{稳定版局部启用}，\texttt{稳定版局部屏蔽}；
不是的话则跳过稳定版约束的 4 个文件，其余文件的相对顺序不变，即：
\texttt{全局启用}，\texttt{全局屏蔽}，\texttt{局部启用}，\texttt{局部屏蔽}。
如果有某个应用标志在不同文件生效时应采取的策略不一致，那么后生效文件的策略覆盖先生效文件的策略。

这 8 个文件都可以用同名目录替代，详见 \ref{sec:profile-files} 节。

\input{profile-variables.tex}

% vim: set filetype=tex fileencoding=utf8 et tw=100 spell spelllang=en :

%%% Local Variables:
%%% mode: latex
%%% TeX-master: "pms"
%%% LaTeX-indent-level: 4
%%% LaTeX-item-indent: 0
%%% TeX-brace-indent-level: 4
%%% fill-column: 100
%%% End:
